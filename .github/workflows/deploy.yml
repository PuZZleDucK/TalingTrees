name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install Render CLI and jq
        run: |
          npm install -g render-cli
          sudo apt-get update && sudo apt-get install -y jq
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          PR_NUMBER: ${{ github.event.workflow_run.pull_requests[0].number }}
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          render login --token "$RENDER_API_KEY"

          SERVICE_NAME="tree-talker"
          EXISTING_ID=$(render services list --json \
            | jq -r --arg NAME "$SERVICE_NAME" '.[] | select(.name==$NAME) | .id')

          if [[ -n "$EXISTING_ID" ]]; then
            echo "✅ Found existing Render service '$SERVICE_NAME' (ID: $EXISTING_ID)."
            SERVICE_ID="$EXISTING_ID"
          else
            echo "⚙️ Creating new Render service '$SERVICE_NAME'…"
            SERVICE_ID=$(render services create web \
              --name "$SERVICE_NAME" \
              --env ruby \
              --region oregon \
              --repo https://github.com/${{ github.repository }}.git \
              --branch main \
              --build-command "bundle install && yarn install && rake assets:precompile" \
              --start-command "bundle exec puma -C config/puma.rb" \
              --output json \
              | jq -r '.id')
            echo "✅ Created service with ID: $SERVICE_ID"
          fi

          render services deploy \
            --service-id "$SERVICE_ID" \
            --branch main
      - name: Comment deployment
        uses: actions/github-script@v6
        with:
          script: |
            const pr = process.env.PR_NUMBER;
            if (pr) {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr,
                body: 'Deploy triggered on Render'
              });
            }
