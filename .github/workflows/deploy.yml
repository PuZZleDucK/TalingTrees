name: Deploy

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install Render CLI and jq
        run: |
          curl -L https://github.com/render-oss/cli/releases/download/v2.1.4/cli_2.1.4_linux_amd64.zip -o render.zip
          unzip render.zip
          sudo mv cli_v2.1.4 /usr/local/bin/render
          sudo apt-get update && sudo apt-get install -y jq
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          SERVICE_NAME="tree-talker"
          render workspace set "tree-workspace"
          EXISTING_ID=$(render services list --confirm --output json \
            | jq -r --arg NAME "$SERVICE_NAME" '.[] | select(.name==$NAME) | .id')

          if [[ -n "$EXISTING_ID" ]]; then
            echo "✅ Found existing Render service '$SERVICE_NAME' (ID: $EXISTING_ID)."
            SERVICE_ID="$EXISTING_ID"
          else
            echo "⚙️ Creating new Render service '$SERVICE_NAME'…"
            SERVICE_ID=$(render services create web \
              --name "$SERVICE_NAME" \
              --env ruby \
              --region oregon \
              --repo https://github.com/${{ github.repository }}.git \
              --branch main \
              --build-command "bundle install && yarn install && rake assets:precompile" \
              --start-command "bundle exec puma -C config/puma.rb" \
              --output json \
              --confirm \
              | jq -r '.id')
            echo "✅ Created service with ID: $SERVICE_ID"
          fi

          render services deploy \
            --service-id "$SERVICE_ID" \
            --branch main
