<!DOCTYPE html>
<html>
<head>
  <title>TalingTrees</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <%= csrf_meta_tags %>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <nav class="flex items-center justify-between border-b border-gray-300 p-4">
    <div class="flex items-center">
      <span class="text-2xl mr-2">üå≥</span>
      <span class="font-bold text-lg">TalingTrees</span>
    </div>
    <div class="flex items-center">
      <span id="user-tags" class="flex mr-2">
        <% (@current_user&.tags_from_trees || []).each do |t| %>
          <span class="bg-gray-200 rounded px-1 text-xs mr-1"><%= t %></span>
        <% end %>
      </span>
      <span class="mr-2">üë§ <%= @current_user&.name %></span>
      <span id="location-info" class="mr-2" data-lat="<%= @current_user&.lat %>" data-long="<%= @current_user&.long %>">
        <span id="locate-icon" class="cursor-pointer">üìç</span>
        <span id="location-text">
          <%= @current_user&.lat && @current_user&.long ? "#{@current_user.lat.round(5)}, #{@current_user.long.round(5)}" : 'unknown' %>
        </span>
      </span>
      <%= form_with url: select_user_path, method: :post, local: true do %>
        <%= select_tag :user_id,
            options_from_collection_for_select(User.all, :id, :name, @current_user&.id),
            onchange: 'this.form.submit();',
            class: 'border rounded p-1' %>
      <% end %>
    </div>
  </nav>
  <%= yield %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          var info = document.getElementById('location-info');
          if (info) {
            info.dataset.lat = pos.coords.latitude;
            info.dataset.long = pos.coords.longitude;
            var txtSpan = info.querySelector('#location-text');
            if (txtSpan) {
              txtSpan.textContent = pos.coords.latitude.toFixed(5) + ', ' + pos.coords.longitude.toFixed(5);
            }
          }
          document.dispatchEvent(new CustomEvent('location-updated', { detail: { lat: pos.coords.latitude, lon: pos.coords.longitude } }));
          fetch('<%= update_location_path %>', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ lat: pos.coords.latitude, long: pos.coords.longitude })
          });
        });
      }
    });
  </script>
</body>
</html>
